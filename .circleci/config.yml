# Python CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-python/ for more details
#
version: 2
workflows:
  version: 2
  test:
    jobs:
      - test-3.7
      - test-3.8

jobs:
  test-3.7: &test-template
    docker:
      - image: circleci/python:3.7-buster

    working_directory: ~/repo

    steps:
      - checkout

      - run:
          name: Install Qt5 binaries
          command: |
            cd ~/
            wget https://download.qt.io/official_releases/qt/5.14/5.14.0/qt-opensource-linux-x64-5.14.0.run
            chmod +x qt-opensource-linux-x64-5.14.0.run
            ./qt-opensource-linux-x64-5.14.0.run --script ~/repo/.circleci/qt-installer-script.js --platform minimal --verbose

      - run:
          name: Install dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y python3-pip xvfb
            sudo pip3 install poetry flake8
            poetry install

      - run:
          name: run flake tests
          command: |
            # stop the build if there are Python syntax errors or undefined names
            flake8 . --count --select=E901,E999,F821,F822,F823 --show-source --statistics
            # exit-zero treats all errors as warnings.  The GitHub editor is 127 chars wide
            flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - run:
          name: run tests
          command: |
            xvfb-run -s "-screen 0 1280x1024x24" poetry run pytest --rungui -vvv --no-qt-log tests/

  test-3.8:
    <<: *test-template
    docker:
      - image: circleci/python:3.8-buster
