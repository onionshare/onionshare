# Python CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-python/ for more details
#
version: 2
workflows:
  version: 2
  test:
    jobs:
      - test-3.7
      - test-3.8

jobs:
  test-3.7: &test-template
    docker:
      - image: circleci/python:3.7-buster

    working_directory: ~/repo

    steps:
      - checkout

      # https://wiki.qt.io/Building_Qt_5_from_Git
      - run:
          name: build Qt5 from source
          command: |
            sudo sh -c 'echo "deb-src http://deb.debian.org/debian buster main" >> /etc/apt/sources.list'
            sudo apt-get update
            sudo apt-get build-dep qt5-default -y
            sudo apt-get install -y libxcb-xinerama0-dev
            sudo apt-get install -y build-essential perl python git
            sudo apt-get install -y '^libxcb.*-dev' libx11-xcb-dev libglu1-mesa-dev libxrender-dev libxi-dev libxkbcommon-dev libxkbcommon-x11-dev
            git clone git://code.qt.io/qt/qt5.git ~/qt5
            cd ~/qt5
            git checkout 5.14.0
            perl init-repository
            export LLVM_INSTALL_DIR=/usr/llvm
            ./configure -developer-build -opensource -confirm-license -nomake examples -nomake tests
            make -j$(nproc)
            make install

      - run:
          name: install dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y python3-pip xvfb
            sudo pip3 install poetry flake8
            poetry install

      - run:
          name: run flake tests
          command: |
            # stop the build if there are Python syntax errors or undefined names
            flake8 . --count --select=E901,E999,F821,F822,F823 --show-source --statistics
            # exit-zero treats all errors as warnings.  The GitHub editor is 127 chars wide
            flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - run:
          name: run tests
          command: |
            xvfb-run -s "-screen 0 1280x1024x24" poetry run pytest --rungui -vvv --no-qt-log tests/

  test-3.8:
    <<: *test-template
    docker:
      - image: circleci/python:3.8-buster
